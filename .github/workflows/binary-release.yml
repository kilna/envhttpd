name: Binary release

on:
  release:
    types:
      - published

permissions:
  contents: write

jobs:
  linux:
    name: Static binaries
    runs-on: ubuntu-latest
    steps:
      - name: Prepare version
        id: prep
        run: |
          TAG=${{ github.event.release.tag_name }}
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build static binaries
        env:
          VERSION: ${{ steps.prep.outputs.version }}
        run: |
          make static VERSION="${VERSION}"
          mkdir -p dist
          for path in out/envhttpd-*; do \
            [ -f "$path" ] || continue; \
            suffix=${path#out/envhttpd-}; \
            cp "$path" "dist/envhttpd-${VERSION}-${suffix}"; \
          done
      - name: Attach to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.prep.outputs.tag }}
          files: dist/envhttpd-${{ steps.prep.outputs.version }}-*
